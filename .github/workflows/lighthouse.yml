name: Site Health Ping

on:
  schedule:
    - cron: '0 3 * * 1' # Mondays at 03:00 UTC
  workflow_dispatch:

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Check SITE_URL configured
        run: |
          if [ -z "${{ secrets.SITE_URL }}" ]; then
            echo "SITE_URL secret is not set. Configure it in GitHub repo settings > Secrets and variables > Actions."
            exit 1
          fi
      - name: Ping site
        run: |
          echo "Checking ${{ secrets.SITE_URL }}"
          # Fail if we don't get a 2xx/3xx status within 5 attempts
          n=0
          until status=$(curl -o /dev/null -s -w "%{http_code}" "${{ secrets.SITE_URL }}"); do
            n=$((n+1))
            if [ "$n" -ge 5 ]; then
              echo "Site not reachable after $n attempts"
              exit 1
            fi
            echo "Attempt $n failed, retrying in 10s..."
            sleep 10
          done

          echo "HTTP status: $status"
          if [ "$status" -ge 400 ]; then
            echo "Site returned error status $status"
            exit 1
          fi
          echo "Site is reachable and healthy enough (status $status)."
